name: Build and Push JEXL Playground Backends

on:
    push:
        branches: [main]
        paths:
            - "backend-python/**"
            - "Konnektr.JexlNet.PlaygroundApi/**"
            - ".github/workflows/jexl-backends.yml"
    workflow_dispatch:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        env:
            REGISTRY: ghcr.io
            IMAGE_PY: ${{ github.repository }}/backend-python
            IMAGE_CS: ${{ github.repository }}/backend-csharp
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Python backend
              uses: docker/build-push-action@v5
              with:
                  context: ./backend-python
                  file: ./backend-python/Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ env.IMAGE_PY }}:latest
                      ghcr.io/${{ env.IMAGE_PY }}:${{ github.sha }}

            - name: Build and push C# backend
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Konnektr.JexlNet.PlaygroundApi/Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ env.IMAGE_CS }}:latest
                      ghcr.io/${{ env.IMAGE_CS }}:${{ github.sha }}
